machine:
  services:
    - docker

test:
  override:
    - godep go test
    - docker build -t ld-relay-build -f Dockerfile-build .
    - docker run --rm -v `pwd`:/build -t -i -e CGO_ENABLED=0 -e GOOS=linux ld-relay-build godep go build -a -installsuffix cgo -o ldr
    - docker build -t "ld-relay:$CIRCLE_BUILD_NUM" .

deployment:
  hub-branch:
    branch: master
    commands:
      - |-
        [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKER_PASSWORD" ] && [ -n "$DOCKER_REPO" ] \
        && ( \
           TAG="$CIRCLE_BRANCH" \
           && echo "build@example.com" | docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" \
           && docker tag "ld-relay:$CIRCLE_BUILD_NUM" "$DOCKER_REPO:$TAG" \
           && docker push "$DOCKER_REPO:$TAG" \
        ) \
        || echo "missing docker environment variables, deployment skipped"
  hub-tag:
    tag: /.*/
    commands:
      - |-
        [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKER_PASSWORD" ] && [ -n "$DOCKER_REPO" ] \
        && ( \
           TAG="$CIRCLE_TAG" \
           && echo "build@example.com" | docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" \
           && docker tag "ld-relay:$CIRCLE_BUILD_NUM" "$DOCKER_REPO:$TAG" \
           && docker push "$DOCKER_REPO:$TAG" \
        ) \
        || echo "missing docker environment variables, deployment skipped"
